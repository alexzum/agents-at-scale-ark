apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: model-custom-headers
spec:
  description: Test model with custom HTTP headers from static values, Secrets, and ConfigMaps
  steps:
  - name: step-1
    try:
    - script:
        skipLogOutput: true
        content: |
          set -u
          echo "{\"token\": \"$E2E_TEST_AZURE_OPENAI_KEY\", \"url\": \"$E2E_TEST_AZURE_OPENAI_BASE_URL\"}"
        outputs:
        - name: azure
          value: (json_parse($stdout))
    - apply:
        file: manifests/*.yaml
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Model
          metadata:
            name: test-model-custom-headers
          status:
            conditions:
            - type: ModelAvailable
              status: "True"
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Model
          metadata:
            name: test-model-custom-headers
          spec:
            config:
              azure:
                headers:
                - name: X-Consumer-Application
                  value:
                    value: ark-chainsaw-test-value
                - name: X-Authorization-Session
                  value:
                    valueFrom:
                      secretKeyRef:
                        name: test-custom-headers
                        key: auth-token
                - name: X-Consumer-Group
                  value:
                    valueFrom:
                      configMapKeyRef:
                        name: test-custom-headers
                        key: consumer-group
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: headers-test-agent
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: custom-headers-query
          status:
            phase: done
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: custom-headers-query
          status:
            (length(responses)): 1
            (contains(responses[*].target.name, 'headers-test-agent')): true
            (length(join('', responses[*].content)) > `5`): true
    - script:
        timeout: 30s
        content: |
          set -e

          echo "Checking controller logs for custom header resolution..."

          LOGS=$(kubectl logs -n ark-system -l app.kubernetes.io/name=ark-controller --tail=500 2>/dev/null || echo "")

          if [ -z "$LOGS" ]; then
            echo "Warning: Could not retrieve controller logs, skipping log validation"
            echo "Headers functionality validated via successful Query completion"
            exit 0
          fi

          STATIC_FOUND=false
          SECRET_FOUND=false
          CONFIGMAP_FOUND=false
          APPLIED_FOUND=false

          if echo "$LOGS" | grep -q "resolved custom header.*X-Consumer-Application"; then
            echo "✓ Static header (X-Consumer-Application) resolved"
            STATIC_FOUND=true
          fi

          if echo "$LOGS" | grep -q "resolved custom header.*X-Authorization-Session"; then
            echo "✓ Secret header (X-Authorization-Session) resolved"
            SECRET_FOUND=true
          fi

          if echo "$LOGS" | grep -q "resolved custom header.*X-Consumer-Group"; then
            echo "✓ ConfigMap header (X-Consumer-Group) resolved"
            CONFIGMAP_FOUND=true
          fi

          if echo "$LOGS" | grep -q "applying custom headers to client.*header_count.*3"; then
            echo "✓ All 3 headers applied to client"
            APPLIED_FOUND=true
          fi

          if [ "$STATIC_FOUND" = true ] && [ "$SECRET_FOUND" = true ] && [ "$CONFIGMAP_FOUND" = true ] && [ "$APPLIED_FOUND" = true ]; then
            echo "✓ All custom headers validated successfully"
            exit 0
          else
            echo "Warning: Some headers not found in logs, but Query succeeded"
            echo "This may indicate timing issues with log retrieval"
            exit 0
          fi
    catch:
    - events: {}
    - describe:
        apiVersion: ark.mckinsey.com/v1alpha1
        kind: Query
        name: custom-headers-query
