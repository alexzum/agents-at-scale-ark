# Mock OpenAI server using mock-llm (https://github.com/dwmkerr/mock-llm)
# Returns all messages to validate memory system message delivery
apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-llm-config
data:
  mock-llm.yaml: |
    rules:
      - path: "/v1/chat/completions"
        match: "@"
        response:
          status: 200
          content: |
            {
              "id": "mock-{{timestamp}}",
              "object": "chat.completion",
              "model": "{{jmes request model}}",
              "choices": [{
                "message": {{jmes request messages}},
                "finish_reason": "stop"
              }]
            }
---
apiVersion: v1
kind: Service
metadata:
  name: mock-llm
spec:
  selector:
    app: mock-llm
  ports:
  - port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Pod
metadata:
  name: mock-llm
  labels:
    app: mock-llm
spec:
  containers:
  - name: mock-llm
    image: ghcr.io/dwmkerr/mock-llm:0.1.8
    ports:
    - containerPort: 8080
    volumeMounts:
    - name: config
      mountPath: /app/mock-llm.yaml
      subPath: mock-llm.yaml
    readinessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 2
      periodSeconds: 5
  volumes:
  - name: config
    configMap:
      name: mock-llm-config
