apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: ark-mcp-integration
spec:
  # Skip test due to Gateway API CRD dependency issues in test environment
  skip: true
  steps:
  - name: setup-rbac
    try:
    - script:
        content: |
          helm install ark-tenant ../../charts/ark-tenant --namespace $NAMESPACE --create-namespace --wait
        env:
        - name: NAMESPACE
          value: ($namespace)

  - name: deploy-ark-mcp-server
    try:
    - script:
        content: |
          helm upgrade --install ark-mcp ../../services/ark-mcp/chart \
            --namespace $NAMESPACE \
            --set app.image.tag=latest \
            --set service.targetPort=2627 \
            --set gateway.enabled=false \
            --wait --timeout=120s
        env:
        - name: NAMESPACE
          value: ($namespace)
        timeout: 180s
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ark-mcp
          status:
            readyReplicas: 1
        timeout: 120s

  - name: test-mcp-namespace-listing
    try:
    - script:
        content: |
          # Wait for service to be ready
          kubectl wait --for=condition=ready pod -l app=ark-mcp --timeout=60s
          
          # Get the service port forward
          kubectl port-forward service/ark-mcp 3000:80 &
          PORT_FORWARD_PID=$!
          
          # Wait a moment for port forward to establish
          sleep 5
          
          # Test the namespace listing via MCP resource
          RESPONSE=$(curl -s http://localhost:3000/resources/ark://namespaces || echo '{"error": "connection failed"}')
          
          # Kill port forward
          kill $PORT_FORWARD_PID 2>/dev/null || true
          
          # Validate response structure
          echo "$RESPONSE" | jq -e '.namespaces | type == "array"' > /dev/null
          if [ $? -eq 0 ]; then
            echo "✓ namespace listing via MCP successful"
            echo "Response: $RESPONSE"
          else
            echo "✗ namespace listing via MCP failed"
            echo "Response: $RESPONSE"
            exit 1
          fi

  - name: cleanup
    try:
    - script:
        content: |
          helm uninstall ark-mcp --namespace $NAMESPACE --ignore-not-found=true
        env:
        - name: NAMESPACE
          value: ($namespace)