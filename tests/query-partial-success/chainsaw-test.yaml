apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: query-partial-success
spec:
  description: Test query with partial success - some targets succeed, others fail
  steps:
  - name: step-1
    try:
    - script:
        skipLogOutput: true
        content: |
          set -u
          echo "{\"token\": \"$E2E_TEST_AZURE_OPENAI_KEY\", \"url\": \"$E2E_TEST_AZURE_OPENAI_BASE_URL\"}"
        outputs:
        - name: azure
          value: (json_parse($stdout))
    - apply:
        file: manifests/*.yaml
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Model
          metadata:
            name: test-model
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: test-agent-1
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: test-agent-2
    # Wait for query to complete with partial success
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: test-query-partial-success
          status:
            # Overall status should be "error" because agent-2 will fail
            phase: error
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: test-query-partial-success
          status:
            (conditions[?type == 'Completed']):
            - status: 'True'
    # Verify we have responses from both successful and failed targets
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: test-query-partial-success
          status:
            # Should have responses from all targets (including failures)
            (length(responses) == `2`): true
            # Should have at least one successful response (agent-1 or team)
            (contains(responses[?phase == 'done'].target.name, 'test-agent-1') || contains(responses[?phase == 'done'].target.name, 'test-team')): true
            # Should have at least one error response (agent-2)
            (contains(responses[?phase == 'error'].target.name, 'test-agent-2')): true
            # Error responses should have content (error message)
            (length(responses[?phase == 'error' && length(content) > `0`]) > `0`): true
            # Error responses should have proper Raw field (not empty "[]")
            (length(responses[?phase == 'error' && raw != '[]']) > `0`): true
    catch:
    - events: {}
    - describe:
        apiVersion: ark.mckinsey.com/v1alpha1
        kind: Query
        name: test-query-partial-success